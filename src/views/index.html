<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Instituciones Registradas</title>
  <script>


<!-- C√©dula del director -->
<label for="ceduladirector">C√©dula del director:</label><br>
<input id="ceduladirector" onblur="buscarPorCedula()" /><br><br>

<!-- Nombre del director (solo lectura) -->
<label for="nombredirector">Nombre del director:</label><br>
<input id="nombredirector" readonly style="background-color: #f0f0f0;" /><br><br>

<!-- Info adicional del director -->
<div id="info-director" style="margin-bottom: 1em; color: #333;"></div>

<!-- B√∫squeda por nombre -->
<label for="busqueda-nombre">Buscar director por nombre:</label><br>
<input id="busqueda-nombre" placeholder="Escribe para buscar..." oninput="buscarPorNombre(this.value)" />
<div id="sugerencias" style="border: 1px solid #ccc; max-height: 120px; overflow-y: auto;"></div><br>

<script>
      async function buscarPorCedula() {
        const cedula = document.getElementById('ceduladirector').value.trim();
        const info = document.getElementById('info-director');
        const nombre = document.getElementById('nombredirector');
        info.innerHTML = '';
        nombre.value = '';
    
        if (!cedula) return;
    
        const res = await fetch('/directores/cedula/' + cedula);
        if (res.ok) {
          const datos = await res.json();
          nombre.value = datos.nombresapellidosrep || '';
          info.innerHTML = `
            üìû <strong>Tel:</strong> ${datos.telefono || '‚Äî'}<br>
            ‚úâÔ∏è <strong>Correo:</strong> ${datos.correo || '‚Äî'}
          `;
        } else {
          info.innerHTML = `<em style="color: red;">Director no registrado</em>`;
        }
      }
    
      async function buscarPorNombre(valor) {
        const lista = document.getElementById('sugerencias');
        lista.innerHTML = '';
        if (valor.trim().length < 2) return;
    
        const res = await fetch('/directores/buscar?q=' + encodeURIComponent(valor));
        if (!res.ok) return;
    
        const datos = await res.json();
        datos.forEach(d => {
          const item = document.createElement('div');
          item.textContent = `${d.nombresapellidosrep} (${d.cedula})`;
          item.style.padding = '5px';
          item.style.cursor = 'pointer';
          item.style.borderBottom = '1px solid #eee';
          item.onclick = () => {
            document.getElementById('ceduladirector').value = d.cedula;
            document.getElementById('nombredirector').value = d.nombresapellidosrep;
            document.getElementById('info-director').innerHTML = `
              üìû <strong>Tel:</strong> ${d.telefono || '‚Äî'}<br>
              ‚úâÔ∏è <strong>Correo:</strong> ${d.correo || '‚Äî'}
            `;
            lista.innerHTML = '';
          };
          lista.appendChild(item);
        });
      }

    
    async function guardarInstitucion() {
      const payload = {
        codigodea: document.getElementById('codigodea').value.trim(),
        nombreplantel: document.getElementById('nombreplantel').value.trim(),
        ceduladirector: document.getElementById('ceduladirector').value.trim(),
        status: 'activo',
        registrado: 'oxiel'
      };
  
      const res = await fetch('/instituciones/nueva', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
  
      if (res.ok) {
        alert('‚úÖ Instituci√≥n registrada con √©xito');
        document.getElementById('formulario').reset();
        document.getElementById('nombredirector').value = '';
        document.getElementById('info-director').innerHTML = '';
        document.getElementById('sugerencias').innerHTML = '';
        if (typeof cargarInstituciones === 'function') cargarInstituciones(); // si tienes una tabla en pantalla
      } else {
        alert('‚ùå Error al registrar instituci√≥n');
      }
    }
  </script>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    #sugerencias div { background: #eee; padding: 5px; cursor: pointer; }
    #sugerencias div:hover { background: #ddd; }
  </style>
</head>
<body>
  <h2>üìò Instituciones registradas</h2>
  <table border="1" cellpadding="5" cellspacing="0">
    <thead>
      <tr>
        <th>C√≥digo DEA</th>
        <th>Nombre</th>
        <th>Director</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="tabla-instituciones"></tbody>
  </table>

  <hr>
  <form id="formulario" onsubmit="event.preventDefault(); guardarInstitucion()" style="max-width: 500px;">
  <h3>‚ûï Registrar nueva instituci√≥n</h3>

  <!-- C√≥digo DEA -->
  <label for="codigodea">C√≥digo DEA:</label><br>
  <input id="codigodea" required /><br><br>

  <!-- Nombre del plantel -->
  <label for="nombreplantel">Nombre del plantel:</label><br>
  <input id="nombreplantel" required /><br><br>

  <!-- C√©dula del director -->
  <label for="ceduladirector">C√©dula del director:</label><br>
  <input id="ceduladirector" onblur="buscarPorCedula()" /><br><br>
  
  <!-- Nombre del director (solo lectura) -->
  <label for="nombredirector">Nombre del director:</label><br>
  <input id="nombredirector" readonly style="background-color: #f0f0f0;" /><br><br>
  
  <!-- Info adicional del director -->
  <div id="info-director" style="margin-bottom: 1em; color: #333;"></div>
  
  <!-- B√∫squeda por nombre -->
  <label for="busqueda-nombre">Buscar director por nombre:</label><br>
  <input id="busqueda-nombre" placeholder="Escribe para buscar..." oninput="buscarPorNombre(this.value)" />
  <div id="sugerencias" style="border: 1px solid #ccc; max-height: 120px; overflow-y: auto;"></div><br>
    
  <button type="submit">Registrar instituci√≥n</button>
</form>
</body>
</html>
